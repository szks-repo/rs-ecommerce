version: "3.9"

services:
  app:
    build: .
    volumes:
      - .:/app
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target:/app/target
    environment:
      RUST_LOG: info
      LOG_FORMAT: json
      ENABLE_OTEL: "true"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
      DATABASE_URL: postgres://rs:rs@db:5432/rs_ecommerce
      REDIS_URL: redis://redis:6379
      MEILI_URL: http://meilisearch:7700
      MEILI_MASTER_KEY: local-master-key
      AUTH_JWT_SECRET: local-dev-secret
    depends_on:
      - db
      - redis
      - meilisearch
    ports:
      - "8080:8080"

  inventory-worker:
    build: .
    command: ["cargo", "run", "-p", "inventory-worker"]
    volumes:
      - .:/app
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target:/app/target
    environment:
      RUST_LOG: info
      LOG_FORMAT: json
      ENABLE_OTEL: "true"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
      DATABASE_URL: postgres://rs:rs@db:5432/rs_ecommerce
      INVENTORY_WORKER_ONESHOT: "false"
      INVENTORY_WORKER_BATCH_SIZE: "50"
      INVENTORY_RESERVATION_TTL_SECONDS: "900"
      INVENTORY_WORKER_SLEEP_MS: "500"
    depends_on:
      - db
      - jaeger

  db:
    image: postgres:16
    environment:
      POSTGRES_USER: rs
      POSTGRES_PASSWORD: rs
      POSTGRES_DB: rs_ecommerce
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  meilisearch:
    image: getmeili/meilisearch:v1.6
    environment:
      MEILI_ENV: development
      MEILI_MASTER_KEY: local-master-key
    ports:
      - "7700:7700"

  jaeger:
    image: jaegertracing/all-in-one:1.58
    ports:
      - "16686:16686"
      - "4317:4317"

volumes:
  pgdata:
  cargo-registry:
  cargo-git:
  target:
