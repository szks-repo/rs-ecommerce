services:
  app:
    build: .
    volumes:
      - .:/app
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target:/app/target
    environment:
      RUST_LOG: info
      LOG_FORMAT: json
      ENABLE_OTEL: "true"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
      DATABASE_URL: postgres://rs:rs@db:5432/rs_ecommerce
      REDIS_URL: redis://redis:6379
      MEILI_URL: http://meilisearch:7700
      MEILI_MASTER_KEY: local-master-key
      AUTH_JWT_SECRET: local-dev-secret
      SMTP_HOST: mailpit
      SMTP_PORT: "1025"
      SMTP_FROM: "no-reply@local.test"
      BASE_URL: "http://localhost:3000"
      AWS_ACCESS_KEY_ID: minio
      AWS_SECRET_ACCESS_KEY: minio123
      AWS_REGION: us-east-1
      AWS_ENDPOINT_URL: http://minio:9000
      AWS_S3_FORCE_PATH_STYLE: "1"
      STORAGE_PUBLIC_PROVIDER: s3
      STORAGE_PUBLIC_BUCKET: rs-public
      STORAGE_PUBLIC_BASE_PATH: ""
      STORAGE_PUBLIC_CDN_BASE_URL: http://localhost:9000/rs-public
      STORAGE_PUBLIC_REGION: us-east-1
      STORAGE_PRIVATE_PROVIDER: s3
      STORAGE_PRIVATE_BUCKET: rs-private
      STORAGE_PRIVATE_BASE_PATH: ""
      STORAGE_PRIVATE_CDN_BASE_URL: ""
      STORAGE_PRIVATE_REGION: us-east-1
    depends_on:
      - db
      - redis
      - meilisearch
      - mailpit
    ports:
      - "8080:8080"

  inventory-worker:
    build: .
    command: ["cargo", "run", "-p", "inventory-worker"]
    volumes:
      - .:/app
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target:/app/target
    environment:
      RUST_LOG: info
      LOG_FORMAT: json
      ENABLE_OTEL: "true"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
      DATABASE_URL: postgres://rs:rs@db:5432/rs_ecommerce
      INVENTORY_WORKER_ONESHOT: "false"
      INVENTORY_WORKER_BATCH_SIZE: "50"
      INVENTORY_RESERVATION_TTL_SECONDS: "900"
      INVENTORY_WORKER_SLEEP_MS: "500"
    depends_on:
      - db
      - jaeger

  customer-sync-worker:
    build: .
    command: ["cargo", "run", "-p", "customer-sync-worker"]
    volumes:
      - .:/app
      - cargo-registry:/usr/local/cargo/registry
      - cargo-git:/usr/local/cargo/git
      - target:/app/target
    environment:
      RUST_LOG: info
      LOG_FORMAT: json
      ENABLE_OTEL: "true"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
      DATABASE_URL: postgres://rs:rs@db:5432/rs_ecommerce
      CUSTOMER_SYNC_WORKER_ONESHOT: "false"
      CUSTOMER_SYNC_BATCH_SIZE: "100"
      CUSTOMER_SYNC_WORKER_SLEEP_MS: "1000"
    depends_on:
      - db
      - jaeger

  db:
    image: postgres:16
    environment:
      POSTGRES_USER: rs
      POSTGRES_PASSWORD: rs
      POSTGRES_DB: rs_ecommerce
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  meilisearch:
    image: getmeili/meilisearch:v1.6
    environment:
      MEILI_ENV: development
      MEILI_MASTER_KEY: local-master-key
    ports:
      - "7700:7700"

  jaeger:
    image: jaegertracing/all-in-one:1.58
    ports:
      - "16686:16686"
      - "4317:4317"

  mailpit:
    image: axllent/mailpit:v1.20
    ports:
      - "1025:1025"
      - "8025:8025"

  # minio:
  #   image: minio/minio:RELEASE.2024-12-18T15-07-50Z
  #   command: server /data --console-address ":9001"
  #   environment:
  #     MINIO_ROOT_USER: minio
  #     MINIO_ROOT_PASSWORD: minio123
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"
  #   volumes:
  #     - minio-data:/data

  # minio-init:
  #   image: minio/mc:RELEASE.2024-12-18T14-57-49Z
  #   depends_on:
  #     - minio
  #   entrypoint: ["/bin/sh", "-c"]
  #   command: >
  #     /usr/bin/mc alias set local http://minio:9000 minio minio123 &&
  #     /usr/bin/mc mb -p local/rs-public &&
  #     /usr/bin/mc mb -p local/rs-private &&
  #     /usr/bin/mc anonymous set download local/rs-public || true

volumes:
  pgdata:
  cargo-registry:
  cargo-git:
  target:
  # minio-data:
